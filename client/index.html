<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="google-signin-client_id"
        content="1086823159539-i2u0ipnl8kkfoh4ukpcgnrnrrnfkeuv8.apps.googleusercontent.com">

    <!--  CSS -->


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <title>Fancy Todo</title>
    <link rel="stylesheet" type="text/css" href="./style/style.css">
    <link rel="stylesheet" href="./style/loginStyle.css">
</head>

<body style="background-image: url('./img/glitch.png');">
    <div id="afterLogin">
        <nav class="navbar navbar-expand-lg navbar-light " style="background-color: #2c3e50;">
            <a class="navbar-brand text-white" href="#">Fancy Todo</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item dropdown ">
                        <a class="nav-link dropdown-toggle text-white" href="#" id="navbarDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Actions
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item btn" data-toggle="modal" data-target="#createModal">Create Todo</a>
                            <a class="dropdown-item btn" id="" data-toggle="modal" data-target="#updateModal">Update
                                Todo</a>
                            <a class="dropdown-item btn deleteTodoClass" id="" onclick="deleteTodo(this.id)">Delete
                                Todo</a>
                        </div>
                    </li>

                </ul>
                <form class="form-inline my-2 my-lg-0">
                    <div id="avatar" class="mr-3">

                    </div>
                    <div class="text-white mr-5" id="user-login-name">

                    </div>
                    <button class="btn btn-danger my-2 my-sm-0" onclick="signOut();" type="button">Sign Out</button>
                </form>
            </div>
        </nav>
        <div class="row ml-5 mr-1" id="todoItem">

        </div>

        <div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Create A Todo</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="exampleInputTitle">Title</label>
                                <input type="text" class="form-control" id="titleCreate" placeholder="Enter Title">
                            </div>

                            <div class="form-group">
                                <label for="exampleInputTitle">Description</label>
                                <input type="text" class="form-control" id="descriptionCreate"
                                    placeholder="Enter Description">
                            </div>

                            <div class="form-group">
                                <label for="exampleInputTitle">Due Date</label>
                                <input type="text" class="form-control" id="dueDateCreate" placeholder="Enter Due Date">
                                <small id="dateHelp" class="form-text text-muted">Format must be yy-mm-dd</small>
                            </div>




                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal"
                            onclick="createTodo();">Create</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Update Todo</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="modal-body" id="updateModalBody">
                        <h1>Select Todo First</h1>
                    </div>
                </div>
            </div>



        </div>
    </div>

    <div id="beforeLogin">

        <div class="col-md-5 col-md-offset-3 col-xs-12" style="margin-left: 370px;">
            <!-- @ Start login box wrapper -->
            <div class="blmd-wrapp">
                <div class="blmd-color-conatiner ripple-effect-All"></div>
                <div class="blmd-header-wrapp ">
                    <div class="blmd-switches">
                        <button class="btn btn-circle btn-lg btn-blmd ripple-effect btn-success blmd-switch-button">
                            <svg style="width:24px;height:24px" viewBox="0 0 24 24">
                                <path fill="#fff" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                            </svg>
                        </button>
                    </div>

                </div>
                <div class="blmd-continer">
                    <!-- @ Login form container -->
                    <form action=" post" method="POST" class="clearfix" id="login-form" style="border-radius: 80px;">
                        <h1>Login Page</h1>
                        <div class="col-md-12">

                            <div class="input-group blmd-form">
                                <div class="blmd-line">
                                    <input type="text" name="username" autocomplete="off" id="logusername"
                                        class="form-control">
                                    <label class="blmd-label">Email or Username</label>
                                </div>
                            </div>
                            <div class="input-group blmd-form">
                                <div class="blmd-line">
                                    <input type="password" name="password" autocomplete="off" id="logpassword"
                                        class="form-control">
                                    <label class="blmd-label">Password</label>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="justify-content: center;">

                            <div class="col-sm-5 text-center">
                                <button type="button" onclick="login();"
                                    class="btn btn-blmd ripple-effect btn-success btn-lg btn-block">Login</button>
                            </div>
                            <div class="col-sm-5  text-center">
                                <div class="g-signin2" style="width: 150px; height: 46px; border-radius: 20px ;"
                                    data-onsuccess="onSignIn"></div>
                            </div>
                        </div>
                        <br />
                    </form>
                    <!-- @ Login form container -->
                    <form action="post" method="POST" class="clearfix form-hidden" id="Register-form">
                        <h1>Register Page</h1>
                        <div class="col-md-12 text-black">

                            <div class="input-group blmd-form">
                                <div class="blmd-line">
                                    <input type="text" name="name" autocomplete="off" id="name" class="form-control">
                                    <label class="blmd-label" style="color: aliceblue;">Name</label>
                                </div>
                            </div>
                            <div class="input-group blmd-form">
                                <div class="blmd-line">
                                    <input type="text" name="username" autocomplete="off" id="username"
                                        class="form-control">
                                    <label class="blmd-label" style="color: aliceblue;">Email</label>
                                </div>
                            </div>
                            <div class="input-group blmd-form">
                                <div class="blmd-line">
                                    <input type="password" name="password" autocomplete="off" id="password"
                                        class="form-control">
                                    <label class="blmd-label" style="color: aliceblue;">Password</label>
                                </div>
                            </div>

                        </div>
                        <div class="col-sm-12 text-center">
                            <button type="button" onclick="register();"
                                class="btn btn-blmd ripple-effect btn-warning btn-lg btn-block">Register</button>
                        </div>
                        <br />
                    </form>
                </div>
            </div>

        </div>

    </div>



    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <script>
        let baseUrl = 'http://localhost:3000'
        $(document).ready(function () {
            auth();

        })


        function auth() {
            if (localStorage.getItem("token")) {
                $("#beforeLogin").hide();
                $("#afterLogin").show();
                $('#avatar').append(
                    `<img src="https://api.adorable.io/avatars/285/${localStorage.getItem('username')}" style="width: 40px;"/>`
                )
                $('#user-login-name').empty()
                $('#user-login-name').append(`<h3>${localStorage.getItem('username')}</h3>`)
                findAllTodos();
            } else {
                $("#afterLogin").hide();
                $("#beforeLogin").show();
            }

        }


        // Before Login
        function login() {
            let email = $("#logusername").val();
            let password = $("#logpassword").val();
            $.ajax({
                method: "post",
                url: "http://localhost:3000/user/login",
                data: {
                    email,
                    password
                }
            }).done((result) => {
                localStorage.setItem("username", result.name);
                localStorage.setItem("token", result.token);
                auth();
            }).fail((err) => {
                Swal.fire({
                    type: 'error',
                    title: 'Oops...',
                    text: err.responseJSON.message,
                })
            })
        }

        function register() {
            console.log("Trigger")
            let name = $("#name").val();
            let email = $("#username").val();
            let password = $("#password").val();

            $.ajax({
                method: "post",
                url: "http://localhost:3000/user/register",
                data: {
                    name,
                    email,
                    password
                }
            }).done((result) => {
                Swal.fire({
                    type: 'success',
                    title: 'Success',
                    text: 'Register Successfully',
                })
                auth();
            }).fail((err) => {

                Swal.fire({
                    type: 'error',
                    title: 'Oops...',
                    text: err.responseJSON.message,
                })
            })
        }

        function onSignIn(googleUser) {
            console.log(googleUser);
            let id_token = googleUser.getAuthResponse().id_token;
            $.ajax({
                method: "post",
                url: "http://localhost:3000/user/logingoogle",
                data: {
                    token: id_token
                }
            }).done((result) => {
                localStorage.setItem("token", result.token);
                localStorage.setItem("username", result.name);
                auth();
            }).fail((err) => {
                Swal.fire({
                    type: 'error',
                    title: 'Oops...',
                    text: err.responseJSON.message,
                })
            })

        }

        function signOut() {
            Swal.fire({
                title: 'Are you sure to signout ?',
                type: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes'
            }).then((result) => {
                if (result.value) {
                    localStorage.removeItem("token");
                    localStorage.removeItem("username")
                    auth();
                    Swal.fire({
                        type: 'success',
                        title: 'Success',
                        text: 'Logout Successfully',
                    })
                    var auth2 = gapi.auth2.getAuthInstance();
                    auth2.signOut().then(function () {
                        localStorage.removeItem("token");
                        localStorage.removeItem("username")
                        auth();
                        Swal.fire({
                            type: 'success',
                            title: 'Success',
                            text: 'Logout Successfully',
                        })
                    });
                    $("#avatar").empty();
                    $('#logusername').val('')
                    $('#logpassword').val('')
                }
            })
        }

        // After Login


        function createTodo() {
            let title = $("#titleCreate").val();
            let description = $("#descriptionCreate").val();
            let dueDate = $("#dueDateCreate").val();
            let name = localStorage.getItem("username");
            let totalTodo = $(".card").length;

            if (totalTodo === 10) {
                Swal.fire({
                    type: 'error',
                    title: 'Oops...',
                    text: "Max Todos Only 10 !!",
                })
            } else {
                $.ajax({
                    method: "post",
                    url: "http://localhost:3000/todo/create",
                    data: {
                        title: title,
                        description: description,
                        status: "false",
                        dueDate: dueDate,
                        username: name
                    }
                }).done((result) => {
                    console.log(result);
                    $("#titleCreate").val("");
                    $("#descriptionCreate").val("");
                    $("#dueDateCreate").val("");
                    Swal.fire({
                        type: 'success',
                        title: 'Success',
                        text: 'Create Todo Successfully',
                    })
                    $("#todoItem").empty();
                    findAllTodos();
                }).fail((err) => {
                    Swal.fire({
                        type: 'error',
                        title: 'Oops...',
                        text: err.responseJSON.message,
                    })
                })
            }



        }

        function findAllTodos() {
            $.ajax({
                method: "post",
                url: "http://localhost:3000/todo/find",
                data: {
                    username: localStorage.getItem("username")
                }
            }).done((result) => {
                for (let i = 0; i < result.length; i++) {

                    let date = new Date(result[i].dueDate).toISOString().slice(0, 10);
                    result[i].dueDate = date


                    $("#todoItem").append(`<div class="card ml-3 col-md-2 mt-5" id="${result[i]._id}"
                style="width: 200px; height: 220px; background-color: #1abc9c;" onclick="select(this.id);">
                <div class="card-body">
                <h5 class="card-title">${result[i].title}</h5>
                <p class="card-text">${result[i].description}</p>
                <h5 class="card-title">${result[i].dueDate}</h5>
                </div>
                </div>`)
                }
            }).fail((err) => {
                Swal.fire({
                    type: 'error',
                    title: 'Oops...',
                    text: err.responseJSON.message,
                })
            })
        }

        function select(id) {
            $.ajax({
                    method: "post",
                    url: "http://localhost:3000/todo/find",
                    data: {
                        username: localStorage.getItem("username")
                    }
                })
                .then((result) => {
                    let selected = "";
                    let isSelect = false;
                    let selectedTitle = "";
                    let selectedDescription = "";
                    let selectedDueDate = "";

                    for (let i = 0; i < result.length; i++) {
                        if (result[i].status === "true") {
                            isSelect = true
                            selected = result[i]._id
                        }

                        if (result[i]._id === id) {
                            selectedTitle = result[i].title;
                            selectedDescription = result[i].description;
                            selectedDueDate = result[i].dueDate;
                        }
                    }

                    if (isSelect === false) {
                        $(".deleteTodoClass").attr("id", `id:${id}`)
                        $("#updateModalBody").empty();
                        $("#updateModalBody").append(`<form id="formUpdate">
                <div class="form-group">
                    <label for="exampleInputTitle">Title</label>
                    <input type="text" class="form-control" id="titleUpdate" value="${selectedTitle}">
                </div>

                <div class="form-group">
                    <label for="exampleInputTitle">Description</label>
                    <input type="text" class="form-control" id="descriptionUpdate"
                        value="${selectedDescription}">
                </div>

                <div class="form-group">
                    <label for="exampleInputTitle">Due Date</label>
                    <input type="text" class="form-control" id="dueDateUpdate" value="${selectedDueDate}">
                    <small id="dateHelp" class="form-text text-muted">Format must be yy-mm-dd</small>
                </div>

            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary updateTodoClass" id="" data-dismiss="modal"
                onclick="updateTodo(this.id);">Update</button>
        </div>`);
                        $(".updateTodoClass").attr("id", `id:${id}`)
                        return $.ajax({
                            method: "post",
                            url: "http://localhost:3000/todo/findById",
                            data: {
                                id
                            }
                        })
                    } else if (isSelect === true && id === selected) {
                        isSelect = false
                        selected = "";
                        $(".updateTodoClass").attr("id", "")
                        $(".deleteTodoClass").attr("id", "")
                        $("#updateModalBody").empty();
                        $("#updateModalBody").append(`<h1> Select Todo First </h1>`)

                        return $.ajax({
                            method: "post",
                            url: "http://localhost:3000/todo/findById",
                            data: {
                                id
                            }
                        })
                    } else {
                        Swal.fire({
                            type: 'error',
                            title: 'Oops...',
                            text: "Dont Select more than 1 Todo !!",
                        })
                    }
                })
                .done((result) => {
                    if (result.status === "false") {
                        $(`#${id}`).css("background-color", "white");
                        return $.ajax({
                            method: "put",
                            url: "http://localhost:3000/todo/selected",
                            data: {
                                id: id,
                                status: "true"
                            }
                        });

                    } else if (result.status === "true") {
                        $(`#${id}`).css("background-color", "#1abc9c");
                        return $.ajax({
                            method: "put",
                            url: "http://localhost:3000/todo/selected",
                            data: {
                                id: id,
                                status: "false"
                            }
                        });
                    }
                })
                .fail((err) => {
                    Swal.fire({
                        type: 'error',
                        title: 'Oops...',
                        text: err.responseJSON.message,
                    })
                })
        }


        function updateTodo(id) {
            let title = $("#titleUpdate").val();
            let description = $("#descriptionUpdate").val();
            let dueDate = $("#dueDateUpdate").val();
            let idUpdate = id.slice(3);
            if (id.length > 0) {
                $.ajax({
                        method: "put",
                        url: "http://localhost:3000/todo/update",
                        data: {
                            title,
                            description,
                            dueDate,
                            id: idUpdate
                        }
                    })
                    .done((result) => {
                        Swal.fire({
                            type: 'success',
                            title: 'Success',
                            text: 'Update Todo Successfully',
                        })
                        $("#todoItem").empty();
                        findAllTodos();
                    })
                    .fail((err) => {
                        Swal.fire({
                            type: 'error',
                            title: 'Oops...',
                            text: err.responseJSON.message,
                        })
                    })
            }
        }



        function deleteTodo(id) {
            if (id.length > 0) {
                Swal.fire({
                    title: 'Are you sure to Delete This Todo?',
                    type: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes'
                }).then((result) => {
                    if (result.value) {
                        let idDelete = id.slice(3);
                        $.ajax({
                                method: "delete",
                                url: "http://localhost:3000/todo/delete",
                                data: {
                                    id: idDelete
                                }
                            })
                            .done((result) => {
                                Swal.fire({
                                    type: 'success',
                                    title: 'Success',
                                    text: 'Delete Todo Successfully',
                                })
                                $("#todoItem").empty();
                                findAllTodos();
                            })
                            .fail((err) => {
                                Swal.fire({
                                    type: 'error',
                                    title: 'Oops...',
                                    text: err.responseJSON.message,
                                })
                            })
                    }
                })

            } else {
                Swal.fire({
                    type: 'error',
                    title: 'Oops...',
                    text: "Select Todo First !!",
                })
            }
        }
    </script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="./script/login.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
    </script>
</body>

</html>